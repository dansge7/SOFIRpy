image: python:3.9.14-bullseye

stages:
  - Static Analysis
  - Test
  - Documentation
  - Release

cache:
  paths:
    - ~/.cache/pip/

before_script:
  - python --version
  - pip install --upgrade pip setuptools
  - pip install virtualenv
  - virtualenv venv
  - source venv/bin/activate
  - pip install ".[test, doc, dev]"

linting:
  stage: Static Analysis
  script:
    - pylint src/sofirpy

type_checking:
  stage: Static Analysis
  script:
    - mypy src/sofirpy

test:
  stage: Test
  script:
    - pytest tests/

doc:
  stage: Documentation
  script:
    - cd docs/
    - make html

release:
  stage: Release
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - tag_version=`echo "$CI_COMMIT_TAG"|cut -d "v" -f2`
    - ver=`pip show sofirpy|grep Version|cut -d " " -f2`
    - |
      if [ "$tag_version" != "$ver" ]
      then
        echo "GitLab TAG "$tag_version" does not match specified version "$ver" in sofirpy/__init__.py"
        exit 1
      fi
    - pip install build twine
    - python -m build
    - TWINE_PASSWORD=${TWINE_PASSWORD} TWINE_USERNAME=${TWINE_USERNAME} twine upload --repository testpypi dist/*
  # release:
  #   tag_name: $CI_COMMIT_TAG
  #   name: 'Release $CI_COMMIT_TAG'
  #   description: ''